# 7. マルチテナント設計

本章では、本システムにおけるマルチテナント構成の考え方と設計方針を定義します。
複数の企業・組織（テナント）が同一システム基盤を共有しつつ、データ・認証・権限を論理的に分離して安全に運用できるように設計します。

## 7-1. 基本方針

- 本システムは、**単一のアプリケーションコードとAWS環境を共有**するマルチテナント構成を採用します。
- テナント間でデータを物理的に分離するため、**すべてのDynamoDBテーブルに `tenant_id` を必須キーとして保持**します。
- 認証およびアクセス制御には **Amazon Cognito** を利用し、ログイン時に `tenant_id` をユーザー属性として付与します。
- テナントごとのUI構成（ラベル・コンポーネント設定）は `ComponentLabelMaster` により管理し、見た目も論理的に独立します。

## 7-2. テナント識別の仕組み

### ■ 認証レイヤ（Cognito）

| 項目             | 内容                                                         |
| ---------------- | ------------------------------------------------------------ |
| **テナント属性** | Cognito ユーザープールの `custom:tenant_id` 属性で管理。     |
| **認証時の流れ** | ログイン成功後、Cognito に `tenant_id` を含めて発行。        |
| **API連携**      | API Gateway  で検証し、`tenant_id` を Lambda 環境変数に渡す。 |
| **権限分離**     | Cognito グループ（Admin／User）により操作可能範囲を制御。    |

### ■ データレイヤ（DynamoDB）

| 対象テーブル               | 分離キー    | 補足                                         |
| -------------------------- | ----------- | -------------------------------------------- |
| `TenantUserMaster`         | `tenant_id` | テナントとユーザー情報を共通テーブルで管理。 |
| `TenantConstructionMaster` | `tenant_id` | 各テナントの工事マスタを独立して保持。       |
| `ComponentLabelMaster`     | `tenant_id` | UI構成・文言設定をテナント単位で保持。       |

すべてのクエリ／更新操作では、**Lambda 側で `tenant_id` をリクエストスコープに必須として渡す**。


## 7-3. テナント追加／削除の運用

今後

## 7-4. テナント間のアクセス制御

- Cognito トークン内の `tenant_id` が **API Gateway のリクエストスコープと一致しない場合**は 403 Forbidden を返す。
- 管理者権限（`role = admin`）を持つユーザーでも、他テナントへのアクセスは不可。
- 監査ログ（CloudWatch Logs）には `tenant_id`、`user_id`、`api_name` を必ず記録する。

## 7-5. テナントごとのUI独立性

- UI構成・ラベル・表示制御は `ComponentLabelMaster` によりテナント単位で定義。
- フロントエンド 側では、ログイン時に `tenant_id` をキーにラベル設定をロードし、UIを動的に再構築。
- 同一画面でも、テナントごとに異なるフォーム構成（例：TextBox数や工事種別などの有無）が可能。