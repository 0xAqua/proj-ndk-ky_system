# 3. データストア設計方針

本システムでは、アプリケーションが利用する永続化データをすべて **DynamoDB** に集約します。 データの特性とアクセスパターンに基づき、以下の3つのテーブルに分離し、それぞれに最適化された設計方針を適用します。

### 3-1. 基本方針：マルチテナント設計

- 全テーブル（`TenantUserMaster`, `TenantConstructionMaster`, `ComponentLabelMaster`）において、**`tenant_id` をパーティションキー（PK）**またはパーティションキーの一部として使用します。
- これにより、すべてのデータがテナントごとに物理的に分離（サイロ化）され、他のテナントのデータに誤ってアクセスするリスクを排除し、スケーラビリティを確保します。

## 3-2. 方針①：Key-Valueストアとしての利用（TenantUserMaster）

テナント情報およびユーザー情報は、いずれも「**IDを指定して、単一の情報を取得する**」という典型的な Key-Value アクセスを中心とするため、
 本システムではこれらを共通のテーブル **`TenantUserMaster`** に統合して管理します。
 これにより、スキーマの一貫性を保ちながら設計・保守のシンプル化と高速アクセスを実現します。

- **`TenantUserMaster` (ユーザテーブル)**
  - **用途:**  テナントの基本設定（テナント名、ドメイン等）およびユーザー情報（権限、部署、メールアドレス等）を統合的に管理します。
     各レコードの種類は `type` 属性で区別します（例：`TENANT`, `USER`）。
  - **設計:**
    - **PK（パーティションキー）:** `tenant_id`
    - **SK（ソートキー）:** `record_id`（例：`TENANT#0001`, `USER#A001`）
    - **type:** データ種別を表す属性。`TENANT` または `USER` を指定。
    - テナント情報・ユーザー情報を同一テーブル内で管理しつつ、`tenant_id` により物理的分離を実現します。
  - **アクセス:**
    1. **テナント情報取得:**
        `GetItem` 操作（`tenant_id` + `record_id = TENANT#0001`）により、特定テナントの基本情報を取得します。
    2. **ユーザー情報取得:**
        `GetItem` 操作（`tenant_id` + `record_id = USER#A001`）により、特定ユーザーの情報を高速に取得します。
    3. **一覧取得（将来的な拡張）:**
        `Query` 操作（`tenant_id` + `begins_with(record_id, "USER#")`）により、テナントに所属する全ユーザーを一覧取得可能です。

## 3-3. 方針②：階層型データストアとしての利用（`TenantConstructionMaster`）

「部門 → 工種 → 工程 → 作業 → 機材 → 現場条件 → その他設備」といった多層構造を持つ工事マスタは、
 UIの階層型ドロップダウンの動作（＝アクセスパターン）に最適化した設計を行います。

- **用途:** 

  UIの入力画面で利用する、階層型の選択肢マスタを管理します。
  フロントエンドでは、このデータをもとに選択肢を動的生成します。

- **設計:** 
  
  **隣接リストパターン (Adjacency List Pattern)** を採用します。
   各アイテムは、上位ノードを示す「パス情報（`nodePath`）」を持ち、階層構造を再現します。
  
  - **PK (Partition Key):** `tenant_id`
     → テナント単位でマスタデータを独立管理。
  - **SK (Sort Key):** `nodePath`
     → 階層構造を示す複合キー。ノードの種類と連番を `#` 区切りで表現。

`nodePath` (SK) には、そのアイテムの階層パスを示す、以下のような文字列が格納されます。

| `nodePath` の値                       | `type` (アイテム種別) | `name` (表示名) |
| ------------------------------------- | --------------------- | --------------- |
| `DEPT#1`                              | Department            | 共通            |
| `DEPT#1#TYPE#1`                       | ConstructionType      | 共通            |
| `DEPT#1#TYPE#1#PROJ#1`                | ConstructionProject   | 二重床          |
| `DEPT#1#TYPE#1#PROJ#1#TASK#1`         | Task                  | 柱上作業        |
| `DEPT#1#TYPE#1#PROJ#1#TASK#1#EQUIP#1` | Equipment             | フルハーネス    |
| `SITE#1`                              | SiteCondition         | 高温環境        |
| `SITE#1#DETAIL#1`                     | SiteConditionDetail   | 室内作業        |
| `OTHEREQUIP#1`                        | OtherEquipment        | 安全標識        |
| `OTHEREQUIP#1#DETAIL#1`               | OtherEquipmentDetail  | 仮設フェンス    |

## 3-4. 方針③：ラベル／コンポーネント設定ストアとしての利用（`ComponentLabelMaster`）

本システムでは、テナント単位で画面コンポーネント名やラベル名を柔軟に変更できるよう、
 **`ComponentLabelMaster`** テーブルを設けます。
 このテーブルは「UI表示設定をKey-Value形式で保持する」ことを目的とし、
 業務や利用者ごとに異なる文言・表記を即時反映できるように設計します。

- **用途:**
   UIコンポーネント（ボタン、入力フォーム、セクションなど）の表示名・ラベル名をテナント単位で管理します。
   これにより、各テナントが自社用語・業務用語に合わせて画面表示をカスタマイズできます。
- **設計:**
  - **PK（パーティションキー）:** `tenant_id`（テナントを一意に識別）
  - **SK（ソートキー）:** `component_key`（UI要素を一意に識別）
  - **属性:** `label_value`（表示ラベル）, `default_value`（初期値）, `locale`（言語コード）, `updatedBy`, `updatedAt` などを保持。
  - Key-Value 形式により、個別コンポーネント単位で高速に取得・更新可能とします。
  - テナント境界でデータを分離し、他テナントへの誤反映を防止します。
