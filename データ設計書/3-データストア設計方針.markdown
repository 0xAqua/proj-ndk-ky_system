# 3. データストア設計方針

本システムでは、アプリケーションが利用する永続化データをすべて **DynamoDB** に集約します。 データの特性とアクセスパターンに基づき、以下の3つのテーブルに分離し、それぞれに最適化された設計方針を適用します。

### 3-1. 基本方針：マルチテナント設計

- 全テーブル（`TenantMaster`, `UserMaster`, `ConstructionMaster`）において、**`tenant_id` をパーティションキー（PK）**またはパーティションキーの一部として使用します。
- これにより、すべてのデータがテナントごとに物理的に分離（サイロ化）され、他のテナントのデータに誤ってアクセスするリスクを排除し、スケーラビリティを確保します。

## 3-2. 方針①：Key-Valueストアとしての利用（`TenantMaster`, `UserMaster`）

テナント情報やユーザー情報は、「IDを指定して、単一の情報を取得する」という典型的なKey-Valueアクセスが中心となります。

- **`TenantMaster` (テナントテーブル)**

  - **用途:** テナント名やドメインなど、テナント全体の基本設定を管理します。

  - **設計:** `tenant_id` を単一の **PK** として設計します。

  - **アクセス:** `GetItem` 操作により、`tenant_id` をキーにテナント情報を高速に取得します。

- **`UserMaster` (ユーザテーブル)**

  - **用途:** ユーザー情報、権限（ロール）、および工事マスタと紐づく**所属部門ID (`department_id`)** を管理します。
  - **設計:** `tenant_id` を **PK**、`user_id` を **SK (ソートキー)** として設計します。
  - **アクセス:**
    1. **単一ユーザー取得:** `GetItem` 操作（PKとSKを両方指定）により、特定のユーザー情報を高速に取得します。
    2. **（将来的な拡張）** `Query` 操作（PKのみ指定）により、テナントに所属する全ユーザーの一覧取得も可能です。

## 3-3. 方針②：階層型データストアとしての利用（`ConstructionMaster`）

「部門 → 工程種別 → 工事工程 → ...」という深い階層を持つ工事マスタは、UIの階層型ドロップダウンの動作（＝アクセスパターン）に合わせて最適化します。

- **用途:** UIの入力画面で利用する、階層型の選択肢マスタを管理します。
- **設計:** **隣接リストパターン (Adjacency List Pattern)** を採用します。
  - **PK (Partition Key):** `tenant_id` を使用します。これにより、テナントごとのマスタデータを1つのパーティションに集約します。
  - **SK (Sort Key):** `nodePath` という複合キーを定義します。このキーに、そのデータが階層のどこに位置するかを示す「**パス情報**」を文字列としてエンコードします。

`nodePath` (SK) には、そのアイテムの階層パスを示す、以下のような文字列が格納されます。

| `nodePath` (SK) の値                | `type` (アイテム種別) | `name` (名前) |
| ----------------------------------- | --------------------- | ------------- |
| DEPT#1                              | Department            | 共通          |
| DEPT#1#TYPE#1                       | ConstructionType      | 共通          |
| DEPT#1#TYPE#1#PROJ#1                | ConstructionProject   | 二重床        |
| DEPT#1#TYPE#1#PROJ#1#TASK#1         | Task                  | 柱上作業      |
| DEPT#1#TYPE#1#PROJ#1#TASK#1#EQUIP#1 | Equipment             | フルハーネス  |
| DEPT#1#TYPE#2                       | ConstructionType      | 基礎          |
| DEPT#2                              | Department            | アクセス      |
| DEPT#2#TYPE#4                       | ConstructionType      | 装機          |
|                                     |                       |               |

