## 4. 画面詳細設計：OTP認証（V000020）

### 4.2.1. 概要

本画面は、ログイン後に送信されたワンタイムパスワード（OTP）を入力し、ユーザーが本人であることを確認するための二要素認証画面である。

ユーザーは、登録済みメールアドレス宛に送信された6桁のOTPを入力し、「認証」ボタンを押下することで本人確認を完了する。

認証に成功すると、危険予知入力画面（V000040）へ遷移する。

### 4.2.2. 画面レイアウト

img

### 4.2.3. 画面項目一覧

**凡例**

- **【種別】**
   A:リンク，B:ボタン，C:チェックボックス，D:カレンダ，L:ドロップダウンリスト，R:ラジオボタン，S:ラベル，T:テキストボックス，U:テキストエリア，F:ファイル選択，I:画像，O:その他(備考に記載)

- **【属性】**
   D:日付，F:全角，H:半角，M:全角半角混在，N:数値

  | No.  | 画面項目名   | 種別 | I/O  | 必須 | 属性 | 桁数 | API名          | 項目名   | 初期値                                                       | 備考                                          |
  | ---- | ------------ | ---- | ---- | ---- | ---- | ---- | -------------- | -------- | ------------------------------------------------------------ | --------------------------------------------- |
  | 1    | システムロゴ | I    | -    | -    | -    | -    | -              | -        | -                                                            | 共通ロゴ（固定）                              |
  | 2    | タイトル     | S    | -    | -    | -    | -    | -              | -        | 「認証」                                                     | 固定文言                                      |
  | 3    | 案内テキスト | S    | -    | -    | -    | -    | -              | -        | 「入力いただいた連絡先が利用できることを確認します。送信されたメールに記載されたワンタイムパスワードを入力してください。」 | 固定文言                                      |
  | 4    | OTP入力欄    | T    | I    | ○    | N    | 6    | auth/verifyOtp | otp_code | -                                                            | 6桁の数値入力欄。自動フォーカス／自動移動あり |
  | 5    | 戻る         | B    | -    | -    | -    | -    | -              | -        | -                                                            | ログイン画面（V000010）に戻る                 |
  | 6    | 認証         | B    | -    | -    | -    | -    | auth/verifyOtp | -        | -                                                            | OTP検証処理を実行                             |

  <p style="text-align: center;"><strong>表 4-4 OTP認証画面項目一覧</strong></p>


### 4.2.4. 画面アクション定義

| No.  | イベント名       | アクションの処理詳細                                         | 遷移先画面名称（ID）    |
| ---- | ---------------- | ------------------------------------------------------------ | ----------------------- |
| 1    | 「認証」クリック | 入力値をバリデーション後、OTP検証APIを呼び出す。成功時：入力画面へ遷移。 | 入力画面（V000040）     |
| 2    | 「戻る」クリック | 前画面（ログイン画面）へ戻る。                               | ログイン画面（V000010） |

<p style="text-align: center;"><strong>表 4-2-2 OTP認証アクション定義一覧</strong></p>

### 4-2-5. バリデーション・エラー処理

#### 4-2-5-1. 入力項目バリデーション

| No   | 画面項目名 | チェック内容            | エラーメッセージ                                | チェックタイミング   |
| ---- | ---------- | ----------------------- | ----------------------------------------------- | -------------------- |
| 1    | OTP入力欄  | 必須チェック            | 「ワンタイムパスワードを入力してください」      | 「認証」ボタン押下時 |
| 2    | OTP入力欄  | 桁数チェック（6桁固定） | 「ワンタイムパスワードは6桁で入力してください」 | 「認証」ボタン押下時 |
| 3    | OTP入力欄  | 数値形式チェック        | 「半角数字のみで入力してください」              | 「認証」ボタン押下時 |

<p style="text-align: center;"><strong>表 4-2-3 入力項目バリデーション一覧</strong></p>

#### 4-2-5-2. 認証エラー処理

| No.  | エラー条件     | エラーメッセージ                                             | 処理内容                                   | 備考                |
| ---- | -------------- | ------------------------------------------------------------ | ------------------------------------------ | ------------------- |
| 1    | OTP不一致      | 「ワンタイムパスワードが無効です。再度お試しください。」     | 入力欄をクリアし、フォーカスを先頭に戻す。 | -                   |
| 2    | OTP期限切れ    | 「ワンタイムパスワードの有効期限が切れています。再送信してください。」 | 再送信ボタンを有効化。                     | 有効期限は5分想定。 |
| 3    | システムエラー | 「システムエラーが発生しました。しばらく時間をおいてから再度お試しください。」 | ログ記録、ユーザーには詳細非表示。         | -                   |

#### 4.2.5.3. エラー表示仕様

エラーメッセージは画面上部（タイトルと入力フォームの間）に表示する。 各エラーパターンの表示例を以下に示す。

[図3-X] エラー表示パターン一覧

- **表示位置**：入力欄の上部（タイトル直下）
- **スタイル**：赤色枠または赤背景のメッセージボックス
- **複数エラー**：同時発生しないため1件表示のみ
- **クリア条件**：再入力または再送信時にクリア

### 4-2-6. セキュリティ要件

- 通信はすべて **HTTPS（TLS1.2以上）** を使用。
- OTPは **6桁の一時コード** で、生成後??分で無効化される。
- 検証成功後は即時トークン破棄し、再利用を防止。
- OTPはサーバー側で暗号化（ハッシュ化）して保持。
- 入力値はブラウザキャッシュおよびオートコンプリート対象外。

### 4-2-7. 表示制御（ComponentLabelMaster対応）

本画面はシステム共通UIとして提供されるため、
 `ComponentLabelMaster` による **ラベル可変／表示制御の対象外** とする。

- タイトル「認証」および案内文は全テナント共通で固定文言を使用。
- OTP入力構成（6桁）は全テナント共通である。